# TOCTOU File Upload + LFI | Medium | Web | 100

## Информация

> PHPickMeUp - это сервис для безопасной загрузки изображений. 
> 
> Сервер тщательно валидирует каждый загруженный файл перед его обработкой.
> Найдите способ получить доступ к содержимому файла flag.txt.
>
> http://<ip>:8080

## Деплой

Запуск задачи на сервере:

```sh
docker compose up --build -d
```

## Описание

PHPickMeUp представляет собой веб-сервис для загрузки изображений с двумя критическими уязвимостями:

1. **TOCTOU (Time-of-Check-Time-of-Use)** - между проверкой файла функцией `getimagesize()` и его использованием есть временное окно (1 секунда), которое можно эксплуатировать для замены валидного изображения на PHP код.

2. **LFI (Local File Inclusion)** - страница `view.php` использует `include($filePath)` для отображения "превью изображения", что позволяет выполнить произвольный PHP код.

Задача демонстрирует реальные уязвимости race condition в веб-приложениях и важность правильной валидации файлов.

## Решение

### Анализ уязвимостей:

1. **TOCTOU в index.php**: После загрузки файла есть задержка `sleep(1)` перед проверкой `getimagesize()`
2. **LFI в view.php**: Прямое включение файла через `include($filePath)`

### Алгоритм атаки:

1. **Загрузить валидное изображение** через форму на главной странице
2. **Получить File ID** из ответа сервера (например: `img_123456789.abcdef`) 
3. **Быстро заменить файл** (в течение 1 секунды) на PHP код:
   ```bash
   echo '<?php echo file_get_contents("flag.txt"); exit; ?>' > uploads/img_123456789.abcdef.jpg
   ```
4. **Обратиться к view.php** для выполнения PHP кода:
   ```
   GET /view.php?id=img_123456789.abcdef
   ```

### Временная диаграмма:
```
0s ────── 0.1s ──── 1.0s ────── 1.1s ────── 1.5s
│         │         │          │          │
Upload    Replace   │ Validate │          Access
file      with      │ (fails   │          view.php
          PHP       │  but too │          (executes
          code      │  late!)  │          PHP code)
          │         │          │          │
          └─────────┴──────────┴──────────┴─────────→
                    ↑                    ↑
              TOCTOU WINDOW         LFI TRIGGER
```



## Флаг

`flag{race_condition_file_inclusion_1337}` 
